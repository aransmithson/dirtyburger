<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Dirty Burgers</title>

<meta name="theme-color" content="#0ea5e9" />
<link rel="manifest" href="manifest.json" />

<style>
:root{
  --bg:#070A12;
  --glass:rgba(255,255,255,0.08);
  --stroke:rgba(255,255,255,0.14);
  --text:#ffffff;
  --muted:rgba(255,255,255,0.65);
  --radius:24px;
}

*{box-sizing:border-box;}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
  background:radial-gradient(circle at 20% 0%,#0ea5e922,transparent 60%),
             radial-gradient(circle at 80% 10%,#22c55e22,transparent 60%),
             var(--bg);
  color:var(--text);
}

header{
  padding:24px 22px 20px;
  backdrop-filter:blur(20px);
  background:rgba(7,10,18,0.9);
  border-bottom:1px solid var(--stroke);
  position:sticky;
  top:0;
  z-index:10;
}

.brand{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.logo-wrap{
  display:flex;
  align-items:center;
  gap:14px;
}

.logo{ font-size:38px; }

h1{
  margin:0;
  font-size:20px;
  font-weight:700;
}

.search-btn{
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:999px;
  padding:10px 16px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
}

main{ padding:26px 22px 60px; }

.card{
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:var(--radius);
  padding:22px;
  margin-bottom:18px;
  backdrop-filter:blur(20px);
  box-shadow:0 20px 45px rgba(0,0,0,.45);
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:16px;
  cursor:pointer;
}

.card h3{ margin:0; font-size:18px; font-weight:600; }

.meta{ margin-top:8px; font-size:14px; color:var(--muted); }

.badge{ width:100px; }

.load-more{
  margin-top:10px;
  padding:16px;
  text-align:center;
  border-radius:999px;
  border:1px solid var(--stroke);
  background:var(--glass);
  cursor:pointer;
  font-weight:600;
}

.loader{
  display:none;
  text-align:center;
  margin:30px 0;
}

.burger{
  font-size:50px;
  animation:bounce 0.8s infinite ease-in-out;
}

@keyframes bounce{
  0%,100%{transform:translateY(0);}
  50%{transform:translateY(-18px);}
}

pre{
  white-space:pre-wrap;
  font-size:12px;
  opacity:.7;
  margin-top:12px;
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo-wrap">
      <div class="logo">üçî</div>
      <h1>Dirty Burgers</h1>
    </div>
  </div>
</header>

<main>
  <div id="list"></div>
  <div class="loader" id="loader"><div class="burger">üçî</div></div>
  <div class="load-more" id="loadMoreBtn">Load More</div>
</main>

<script>
const DEBUG = new URLSearchParams(window.location.search).get("debug") === "1";

const PAGE_SIZE=200;
let page=1;
let userLat,userLon;
let allPlaces=[];
let displayCount=15;
let currentPlaces=[];

const ALLOWED=new Set([
  "Restaurant/Cafe/Canteen",
  "Pub/bar/nightclub",
  "Takeaway/sandwich shop",
  "Mobile caterer"
]);

function escapeHtml(str){
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;");
}

function distance(lat1,lon1,lat2,lon2){
  const R=3958.8;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

function badge(r){
  const n=Number(r);
  return !isNaN(n)?`images/fhrs_${n}_en-gb.svg`:`images/fhrs_exempt_en-gb.svg`;
}

function showLoader(show){
  document.getElementById("loader").style.display=show?"block":"none";
}

async function fetchNextPage(){
  showLoader(true);

  const res=await fetch(
    `https://api.ratings.food.gov.uk/Establishments?latitude=${userLat}&longitude=${userLon}&pageSize=${PAGE_SIZE}&pageNumber=${page}&sortOptionKey=RatingValue&sortDirection=asc`,
    {headers:{"x-api-version":"2"}}
  );

  const data=await res.json();

  if(DEBUG){
    console.log("API PAGE", page, data.establishments);
  }

  data.establishments.forEach(e=>{
    if(!e.geocode?.latitude) return;
    if(!ALLOWED.has(e.BusinessType)) return;

    const d=distance(userLat,userLon,e.geocode.latitude,e.geocode.longitude);
    allPlaces.push({...e,distance:d});
  });

  allPlaces.sort((a,b)=>a.distance-b.distance);

  page++;
  render();
  showLoader(false);
}

function render(){
  currentPlaces = allPlaces.slice(0,displayCount);

  document.getElementById("list").innerHTML=
    currentPlaces.map((p,i)=>`
      <div class="card">
        <div>
          <h3>${escapeHtml(p.BusinessName)}</h3>
          <div class="meta">
            ${p.distance.toFixed(2)} miles ‚Ä¢ 
            ${escapeHtml(p.BusinessType)} ‚Ä¢ 
            Rating: ${escapeHtml(p.RatingValue)}
          </div>

          ${DEBUG ? `
            <pre>${escapeHtml(JSON.stringify(p,null,2))}</pre>
          ` : ``}
        </div>
        <img class="badge" src="${badge(p.RatingValue)}">
      </div>
    `).join("");
}

document.getElementById("loadMoreBtn").onclick=()=>{
  displayCount+=15;
  if(displayCount>allPlaces.length){
    fetchNextPage();
  } else {
    render();
  }
};

navigator.geolocation.getCurrentPosition(pos=>{
  userLat=pos.coords.latitude;
  userLon=pos.coords.longitude;
  fetchNextPage();
});
</script>

</body>
</html>
